<?xml version="1.0"?>
<AlteryxDocument yxmdVer="11.3">
  <Nodes>
    <Node ToolID="1">
      <GuiSettings Plugin="AlteryxBasePluginsGui.DbFileInput.DbFileInput">
        <Position x="54" y="150" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Passwords>498212DC0C96BB024DC50B75B7220C9B5ED03B6C6DE73</Passwords>
          <File RecordLimit="" FileFormat="17">oci:JUMORRIS/__EncPwd1__@SBP416.world|||WITH bl AS
(select b.FSCL_YR_NUM
  ,b.FSCL_PER_IN_YR_NUM
  ,a.GUID_ID
  ,count(*) AS TRANS
  ,sq.TOTAL_TB
  ,sq.TOTAL_RSPNS

from APPCA.F_SVC_FIN_TRANS a

inner join APPCA.D_CAL b 
  on a.BUS_DT = b.CAL_DT

inner join APPCA.D_SVC_TRANS_TYPE c 
  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY
  
JOIN APPCA.D_STORE_VERS st
  ON a.STORE_NUM = st.STORE_NUM
    AND st.CURRENT_FLG = 'Y'
    AND st.OWNR_TYPE_CD = 'CO'
    AND st.CNTRY_CD_2_DGT_ISO = 'US'

inner join (SELECT
  sr.GUID_USER_ID
  ,SUM(CASE WHEN sr.RSPNS_ID = '7' AND sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_TB
  ,SUM(CASE WHEN sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_RSPNS
  ,ca.FSCL_YR_NUM
  ,ca.FSCL_PER_IN_YR_NUM
  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE
FROM APPOTHER.AFT_CV_SRVY_RSPNS sr

JOIN APPCA.D_CAL ca
  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)

WHERE ((ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM &lt;=3) OR (ca.FSCL_YR_NUM = 2017 and ca.FSCL_PER_IN_YR_NUM &gt; 2))
  AND sr.QSTN_ID IN ('Q2_2')
  --AND sr.STORE_NUM = 5798 -- for testing
  AND sr.RSPNS_ID &lt;&gt; '9'
  --AND TRUNC(sr.TRANS_DTM) = '31-OCT-17'
  --AND sr.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')
GROUP BY 
  sr.GUID_USER_ID
  ,ca.FSCL_YR_NUM
  ,ca.FSCL_PER_IN_YR_NUM
  ,TRUNC(sr.TRANS_DTM)
  ) sq
  
ON a.GUID_ID = sq.GUID_USER_ID
  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM
  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM

where c.SVC_INTRNL_RQST_NM = 'Redemption' 
  AND ((b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM &lt;=3) OR (b.FSCL_YR_NUM = 2017 and b.FSCL_PER_IN_YR_NUM &gt; 2))
  --AND a.BUS_DT BETWEEN sq.SVY_RSPN_DATE - 30 AND sq.SVY_RSPN_DATE
  --AND sq.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')
group by b.FSCL_YR_NUM
  ,b.FSCL_PER_IN_YR_NUM
  ,a.GUID_ID
  ,sq.TOTAL_TB
  ,sq.TOTAL_RSPNS
  ) 
SELECT 
  bl.FSCL_YR_NUM
  ,bl.FSCL_PER_IN_YR_NUM
  ,count(bl.GUID_ID) AS USER_COUNT
  ,bl.TRANS
  ,sum(bl.TOTAL_TB) AS TB_COUNT
  ,sum(bl.TOTAL_RSPNS) AS RSPSN_COUNT
FROM bl
GROUP BY 
  bl.FSCL_YR_NUM
  ,bl.FSCL_PER_IN_YR_NUM
  ,bl.TRANS
ORDER BY
  bl.FSCL_YR_NUM
  ,bl.FSCL_PER_IN_YR_NUM
  ,bl.TRANS</File>
          <FormatSpecificOptions>
            <ForceSqlWcharSupport>False</ForceSqlWcharSupport>
            <ReadCentroids>False</ReadCentroids>
            <TableStyle>Quoted</TableStyle>
            <NoProgress>False</NoProgress>
            <CacheData>False</CacheData>
            <PostSQL />
            <PreSQL />
          </FormatSpecificOptions>
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText>Database: @SBP416.world
Table=WITH bl AS
(select b.FSCL_YR_NUM
  ,b.FSCL_PER_IN_YR_NUM
  ,a.GUID_ID
  ,count(*) AS TRANS
  ,sq.TOTAL_TB
  ,sq.TOTAL_RSPNS

from APPCA.F_SVC_FIN_TRANS a

inner join APPCA.D_CAL b 
  on a.BUS_DT = b.CAL_DT

inner join APPCA.D_SVC_TRANS_TYPE c 
  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY
  
JOIN APPCA.D_STORE_VERS st
  ON a.STORE_NUM = st.STORE_NUM
    AND st.CURRENT_FLG = 'Y'
    AND st.OWNR_TYPE_CD = 'CO'
    AND st.CNTRY_CD_2_DGT_ISO = 'US'

inner join (SELECT
  sr.GUID_USER_ID
  ,SUM(CASE WHEN sr.RSPNS_ID = '7' AND sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_TB
  ,SUM(CASE WHEN sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_RSPNS
  ,ca.FSCL_YR_NUM
  ,ca.FSCL_PER_IN_YR_NUM
  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE
FROM APPOTHER.AFT_CV_SRVY_RSPNS sr

JOIN APPCA.D_CAL ca
  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)

WHERE ((ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM &lt;=3) OR (ca.FSCL_YR_NUM = 2017 and ca.FSCL_PER_IN_YR_NUM &gt; 2))
  AND sr.QSTN_ID IN ('Q2_2')
  --AND sr.STORE_NUM = 5798 -- for testing
  AND sr.RSPNS_ID &lt;&gt; '9'
  --AND TRUNC(sr.TRANS_DTM) = '31-OCT-17'
  --AND sr.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')
GROUP BY 
  sr.GUID_USER_ID
  ,ca.FSCL_YR_NUM
  ,ca.FSCL_PER_IN_YR_NUM
  ,TRUNC(sr.TRANS_DTM)
  ) sq
  
ON a.GUID_ID = sq.GUID_USER_ID
  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM
  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM

where c.SVC_INTRNL_RQST_NM = 'Redemption' 
  AND ((b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM &lt;=3) OR (b.FSCL_YR_NUM = 2017 and b.FSCL_PER_IN_YR_NUM &gt; 2))
  --AND a.BUS_DT BETWEEN sq.SVY_RSPN_DATE - 30 AND sq.SVY_RSPN_DATE
  --AND sq.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')
group by b.FSCL_YR_NUM
  ,b.FSCL_PER_IN_YR_NUM
  ,a.GUID_ID
  ,sq.TOTAL_TB
  ,sq.TOTAL_RSPNS
  ) 
SELECT 
  bl.FSCL_YR_NUM
  ,bl.FSCL_PER_IN_YR_NUM
  ,count(bl.GUID_ID) AS USER_COUNT
  ,bl.TRANS
  ,sum(bl.TOTAL_TB) AS TB_COUNT
  ,sum(bl.TOTAL_RSPNS) AS RSPSN_COUNT
FROM bl
GROUP BY 
  bl.FSCL_YR_NUM
  ,bl.FSCL_PER_IN_YR_NUM
  ,bl.TRANS
ORDER BY
  bl.FSCL_YR_NUM
  ,bl.FSCL_PER_IN_YR_NUM
  ,bl.TRANS</DefaultAnnotationText>
          <Left value="False" />
        </Annotation>
        <MetaInfo connection="Output">
          <RecordInfo>
            <Field name="FSCL_YR_NUM" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||WITH bl AS&#xA;(select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,SUM(CASE WHEN sr.RSPNS_ID = '7' AND sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_TB&#xA;  ,SUM(CASE WHEN sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_RSPNS&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ((ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM &lt;=3) OR (ca.FSCL_YR_NUM = 2017 and ca.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;  --AND sr.STORE_NUM = 5798 -- for testing&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;  --AND TRUNC(sr.TRANS_DTM) = '31-OCT-17'&#xA;  --AND sr.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND ((b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM &lt;=3) OR (b.FSCL_YR_NUM = 2017 and b.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  --AND a.BUS_DT BETWEEN sq.SVY_RSPN_DATE - 30 AND sq.SVY_RSPN_DATE&#xA;  --AND sq.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;  ) &#xA;SELECT &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,count(bl.GUID_ID) AS USER_COUNT&#xA;  ,bl.TRANS&#xA;  ,sum(bl.TOTAL_TB) AS TB_COUNT&#xA;  ,sum(bl.TOTAL_RSPNS) AS RSPSN_COUNT&#xA;FROM bl&#xA;GROUP BY &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS&#xA;ORDER BY&#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS" type="Double" />
            <Field name="FSCL_PER_IN_YR_NUM" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||WITH bl AS&#xA;(select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,SUM(CASE WHEN sr.RSPNS_ID = '7' AND sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_TB&#xA;  ,SUM(CASE WHEN sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_RSPNS&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ((ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM &lt;=3) OR (ca.FSCL_YR_NUM = 2017 and ca.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;  --AND sr.STORE_NUM = 5798 -- for testing&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;  --AND TRUNC(sr.TRANS_DTM) = '31-OCT-17'&#xA;  --AND sr.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND ((b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM &lt;=3) OR (b.FSCL_YR_NUM = 2017 and b.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  --AND a.BUS_DT BETWEEN sq.SVY_RSPN_DATE - 30 AND sq.SVY_RSPN_DATE&#xA;  --AND sq.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;  ) &#xA;SELECT &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,count(bl.GUID_ID) AS USER_COUNT&#xA;  ,bl.TRANS&#xA;  ,sum(bl.TOTAL_TB) AS TB_COUNT&#xA;  ,sum(bl.TOTAL_RSPNS) AS RSPSN_COUNT&#xA;FROM bl&#xA;GROUP BY &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS&#xA;ORDER BY&#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS" type="Double" />
            <Field name="USER_COUNT" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||WITH bl AS&#xA;(select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,SUM(CASE WHEN sr.RSPNS_ID = '7' AND sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_TB&#xA;  ,SUM(CASE WHEN sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_RSPNS&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ((ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM &lt;=3) OR (ca.FSCL_YR_NUM = 2017 and ca.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;  --AND sr.STORE_NUM = 5798 -- for testing&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;  --AND TRUNC(sr.TRANS_DTM) = '31-OCT-17'&#xA;  --AND sr.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND ((b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM &lt;=3) OR (b.FSCL_YR_NUM = 2017 and b.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  --AND a.BUS_DT BETWEEN sq.SVY_RSPN_DATE - 30 AND sq.SVY_RSPN_DATE&#xA;  --AND sq.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;  ) &#xA;SELECT &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,count(bl.GUID_ID) AS USER_COUNT&#xA;  ,bl.TRANS&#xA;  ,sum(bl.TOTAL_TB) AS TB_COUNT&#xA;  ,sum(bl.TOTAL_RSPNS) AS RSPSN_COUNT&#xA;FROM bl&#xA;GROUP BY &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS&#xA;ORDER BY&#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS" type="Double" />
            <Field name="TRANS" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||WITH bl AS&#xA;(select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,SUM(CASE WHEN sr.RSPNS_ID = '7' AND sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_TB&#xA;  ,SUM(CASE WHEN sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_RSPNS&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ((ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM &lt;=3) OR (ca.FSCL_YR_NUM = 2017 and ca.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;  --AND sr.STORE_NUM = 5798 -- for testing&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;  --AND TRUNC(sr.TRANS_DTM) = '31-OCT-17'&#xA;  --AND sr.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND ((b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM &lt;=3) OR (b.FSCL_YR_NUM = 2017 and b.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  --AND a.BUS_DT BETWEEN sq.SVY_RSPN_DATE - 30 AND sq.SVY_RSPN_DATE&#xA;  --AND sq.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;  ) &#xA;SELECT &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,count(bl.GUID_ID) AS USER_COUNT&#xA;  ,bl.TRANS&#xA;  ,sum(bl.TOTAL_TB) AS TB_COUNT&#xA;  ,sum(bl.TOTAL_RSPNS) AS RSPSN_COUNT&#xA;FROM bl&#xA;GROUP BY &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS&#xA;ORDER BY&#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS" type="Double" />
            <Field name="TB_COUNT" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||WITH bl AS&#xA;(select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,SUM(CASE WHEN sr.RSPNS_ID = '7' AND sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_TB&#xA;  ,SUM(CASE WHEN sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_RSPNS&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ((ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM &lt;=3) OR (ca.FSCL_YR_NUM = 2017 and ca.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;  --AND sr.STORE_NUM = 5798 -- for testing&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;  --AND TRUNC(sr.TRANS_DTM) = '31-OCT-17'&#xA;  --AND sr.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND ((b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM &lt;=3) OR (b.FSCL_YR_NUM = 2017 and b.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  --AND a.BUS_DT BETWEEN sq.SVY_RSPN_DATE - 30 AND sq.SVY_RSPN_DATE&#xA;  --AND sq.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;  ) &#xA;SELECT &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,count(bl.GUID_ID) AS USER_COUNT&#xA;  ,bl.TRANS&#xA;  ,sum(bl.TOTAL_TB) AS TB_COUNT&#xA;  ,sum(bl.TOTAL_RSPNS) AS RSPSN_COUNT&#xA;FROM bl&#xA;GROUP BY &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS&#xA;ORDER BY&#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS" type="Double" />
            <Field name="RSPSN_COUNT" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||WITH bl AS&#xA;(select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,SUM(CASE WHEN sr.RSPNS_ID = '7' AND sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_TB&#xA;  ,SUM(CASE WHEN sr.QSTN_ID = 'Q2_2' THEN 1 ELSE 0 END) AS TOTAL_RSPNS&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ((ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM &lt;=3) OR (ca.FSCL_YR_NUM = 2017 and ca.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;  --AND sr.STORE_NUM = 5798 -- for testing&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;  --AND TRUNC(sr.TRANS_DTM) = '31-OCT-17'&#xA;  --AND sr.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND ((b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM &lt;=3) OR (b.FSCL_YR_NUM = 2017 and b.FSCL_PER_IN_YR_NUM &gt; 2))&#xA;  --AND a.BUS_DT BETWEEN sq.SVY_RSPN_DATE - 30 AND sq.SVY_RSPN_DATE&#xA;  --AND sq.GUID_USER_ID IN ('0A431223-46E3-438C-B301-B9AEDE967A29','6454D29D-5CC3-4809-AD03-4FA2CBCCFF6B','8F959E6B-5B96-4FD9-B699-04CDE1475DC5')&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,sq.TOTAL_TB&#xA;  ,sq.TOTAL_RSPNS&#xA;  ) &#xA;SELECT &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,count(bl.GUID_ID) AS USER_COUNT&#xA;  ,bl.TRANS&#xA;  ,sum(bl.TOTAL_TB) AS TB_COUNT&#xA;  ,sum(bl.TOTAL_RSPNS) AS RSPSN_COUNT&#xA;FROM bl&#xA;GROUP BY &#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS&#xA;ORDER BY&#xA;  bl.FSCL_YR_NUM&#xA;  ,bl.FSCL_PER_IN_YR_NUM&#xA;  ,bl.TRANS" type="Double" />
          </RecordInfo>
        </MetaInfo>
      </Properties>
      <EngineSettings EngineDll="AlteryxBasePluginsEngine.dll" EngineDllEntryPoint="AlteryxDbFileInput" />
    </Node>
    <Node ToolID="2">
      <GuiSettings Plugin="AlteryxBasePluginsGui.BrowseV2.BrowseV2">
        <Position x="186" y="150" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <TempFile>C:\Users\jumorris\AppData\Local\Temp\Engine_17776_3da1d2a4873345f99e2b9fd2792101b2_\Engine_1452_0c96cc2170ce478db7edad3550e8d2e3_.yxdb</TempFile>
          <TempFileDataProfiling />
          <Layout>
            <ViewMode>Single</ViewMode>
            <ViewSize value="100" />
            <View1>
              <DefaultTab>Profile</DefaultTab>
              <Hints>
                <Table />
              </Hints>
            </View1>
            <View2 />
          </Layout>
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
      <EngineSettings EngineDll="AlteryxBasePluginsEngine.dll" EngineDllEntryPoint="AlteryxBrowseV2" />
    </Node>
    <Node ToolID="3">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="54" y="54" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text><![CDATA[CC Scores by Customer Freq
]]></Text>
          <Font name="Segoe UI" size="8.25" style="1" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="2" />
          <Justification Justification="1" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="4">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="54" y="102" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text>Uses multiple sub-queries to first grab GUIDs for CE survey responses, then calculates the transaction frequency of each GUID, then makes frequency bins, then calculates CC scores for each frequency bin.

Does this for December 2018 CC only.</Text>
          <Font name="Segoe UI" size="8.25" style="0" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="0" />
          <Justification Justification="4" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="5">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="474" y="54" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text><![CDATA[Key Results
]]></Text>
          <Font name="Segoe UI" size="8.25" style="1" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="2" />
          <Justification Justification="1" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="6">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="474" y="102" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text>CC Scores increase steadily with monthly transaction frequency.</Text>
          <Font name="Segoe UI" size="8.25" style="0" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="0" />
          <Justification Justification="4" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="7">
      <GuiSettings Plugin="AlteryxRPluginGui.R">
        <Position x="306" y="150" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <RScript>##SR/Non-SR Analysis using Brand Equity Study##
##December FY 18 data##

#load libraries
library(data.table)
library(foreign)
library(tidyverse)
library(ggthemes)
library(patchwork)

#load data
be &lt;- read.spss("//starbucks/amer/portal/Departments/WMO/Marketing Research/New Q drive/Foundational/Brand Equity Monitor/$ Brand Equity 2.0/SPSS/DEC FY18 Final.sav", use.value.labels = FALSE, to.data.frame=TRUE)
#convert to data.table
setDT(be)

#keep only variables we need
be &lt;- be[, .(ProvenSR,Q5Starbucks_TotalVisits,QSB3_GotMyOrderRight_slice,QSB3_TheStoreWasClean_slice,
             QSB3_MadeAnEffortToGetToKnowMe_slice,QSB3_MyBeverageTastedGreat_slice,
             QSB3_WentAboveAndBeyondMyExpectations_slice,
             QSB3_WasAbleToPlacAndPickUpMyOrderInAReasonableAmounOfTime_slice,
             QSB3_MyFoodTastedGreat_slice,QSB3_PurchaseWasWorthWhatIPaid_slice)]

#drop NA's for core variables
be &lt;- na.omit(be, cols=c("ProvenSR","Q5Starbucks_TotalVisits","QSB3_MadeAnEffortToGetToKnowMe_slice"))

#recode ProvenSR to binary
be[ProvenSR==2, ProvenSR := 0]

#rename long variables
setnames(be,c("Q5Starbucks_TotalVisits","QSB3_GotMyOrderRight_slice","QSB3_TheStoreWasClean_slice",
              "QSB3_MadeAnEffortToGetToKnowMe_slice","QSB3_MyBeverageTastedGreat_slice",
              "QSB3_WentAboveAndBeyondMyExpectations_slice",
              "QSB3_WasAbleToPlacAndPickUpMyOrderInAReasonableAmounOfTime_slice",
              "QSB3_MyFoodTastedGreat_slice","QSB3_PurchaseWasWorthWhatIPaid_slice"),
         c("visits","Q2_4","Q2_7","Q2_2","Q2_5","Q2_3","Q2_1","Q2_6","Q2_8"))

#create TB variables
be[Q2_4&lt;7, Q2_4_score := 0]; be[Q2_4==7, Q2_4_score := 1]
be[Q2_7&lt;7, Q2_7_score := 0]; be[Q2_7==7, Q2_7_score := 1]
be[Q2_2&lt;7, Q2_2_score := 0]; be[Q2_2==7, Q2_2_score := 1]
be[Q2_5&lt;7, Q2_5_score := 0]; be[Q2_5==7, Q2_5_score := 1]
be[Q2_3&lt;7, Q2_3_score := 0]; be[Q2_3==7, Q2_3_score := 1]
be[Q2_1&lt;7, Q2_1_score := 0]; be[Q2_1==7, Q2_1_score := 1]
be[Q2_6&lt;7, Q2_6_score := 0]; be[Q2_6==7, Q2_6_score := 1]
be[Q2_8&lt;7, Q2_8_score := 0]; be[Q2_8==7, Q2_8_score := 1]

#create frequency bins (1: 1-5, 2: 6-10, 3: 11-15, 4: 16+)
be[visits&lt;=5, vis_bin := 1]
be[visits&gt;=6&amp;visits&lt;=10, vis_bin := 2]
be[visits&gt;=11&amp;visits&lt;=15, vis_bin := 3]
be[visits&gt;=16, vis_bin := 4]

#calculate proportions in each group
tempbe &lt;- be %&gt;%
  group_by(vis_bin,ProvenSR) %&gt;%
  summarize(Q2_4_score = round(mean(Q2_4_score,na.rm=T)*100,1), #accuracy
            Q2_7_score = round(mean(Q2_7_score,na.rm=T)*100,1), #clean
            Q2_2_score = round(mean(Q2_2_score,na.rm=T)*100,1), #cc
            Q2_5_score = round(mean(Q2_5_score,na.rm=T)*100,1), #bev taste
            Q2_3_score = round(mean(Q2_3_score,na.rm=T)*100,1), #above &amp; beyond
            Q2_1_score = round(mean(Q2_1_score,na.rm=T)*100,1), #speed
            Q2_6_score = round(mean(Q2_6_score,na.rm=T)*100,1), #food taste
            Q2_8_score = round(mean(Q2_8_score,na.rm=T)*100,1), #worth
            n = n())
setDT(tempbe)

#bring in our data
ce &lt;- fread("O:/CoOp/CoOp194_PROReportng&amp;OM/Julie/ce_by_customer_frequency_v2.csv")

#keep only december fy18
ce &lt;- ce[FSCL_YR_NUM==2018&amp;FSCL_PER_IN_YR_NUM==3]

#create frequency bins (1: 1-5, 2: 6-10, 3: 11-15, 4: 16+)
ce[TRANS&lt;=5, vis_bin := 1]
ce[TRANS&gt;=6&amp;TRANS&lt;=10, vis_bin := 2]
ce[TRANS&gt;=11&amp;TRANS&lt;=15, vis_bin := 3]
ce[TRANS&gt;=16, vis_bin := 4]

#aggregate by vis_bin and question
ce &lt;- ce[, list(USER_COUNT = sum(USER_COUNT,na.rm=T),
                TB_COUNT = sum(TB_COUNT,na.rm=T),
                RSPSN_COUNT = sum(RSPSN_COUNT,na.rm=T)),
         by=c("vis_bin")]
#make fake SR variable for plotting
ce[, ProvenSR := 1]

#freq table
ce %&gt;% transmute(vis_bin, percent = USER_COUNT/sum(USER_COUNT))

#calculate TB score
ce[, tb_score := round((TB_COUNT / RSPSN_COUNT)*100,1)]

#plot 1: customer connection from brand equity
#set labels
# xlabel &lt;- "Proven SR"
xlabels &lt;- c("Non-SR","SR")
ylabel &lt;- "CC Score"
tlabel &lt;- "Brand Equity Study"
sublabel &lt;- "Customer Connection"
caption &lt;- "Brand Equity Study, December FY18"
#manual legend labels
lname &lt;- "30-Day Visitation"
llabels &lt;- c("1-5", "6-10", "11-15", "16+")
#values
pdata1a &lt;- tempbe
px1a &lt;- tempbe[,ProvenSR]
py1a &lt;- tempbe[,Q2_2_score]
groupvar1a &lt;- tempbe[,vis_bin]
nvar1a &lt;- tempbe[,n]
#plot itself
plot1a &lt;- ggplot(data=pdata1a,aes(y=py1a,x=as.factor(px1a),fill=as.factor(groupvar1a))) + 
  geom_bar(stat="identity", width = 0.95, position=position_dodge(), colour="black") +
  scale_fill_brewer(palette = 1, name=lname, labels=llabels) + theme_economist() +
  scale_x_discrete(name="",labels=xlabels) +
  xlab("") + ylab(ylabel) + ggtitle(tlabel) + labs(subtitle=sublabel,caption=caption) +
  geom_text(size = 3.5, aes(label=py1a,y=0), stat="identity", vjust = -2, position = position_dodge(0.95)) +
  geom_text(size = 2.5, aes(label=paste0("n=",nvar1a),y=0), stat= "identity", vjust = -1, position = position_dodge(0.95)) 
print(plot1a)

#plot 1b: customer connection from ce survey
#make fake grouping variable
#set labels
# xlabel &lt;- "Proven SR"
xlabels &lt;- c("SR")
ylabel &lt;- "CC Score"
tlabel &lt;- "Customer Experience Survey"
sublabel &lt;- "Customer Connection"
caption &lt;- "Customer Experience Survey, December FY18"
#manual legend labels
lname &lt;- "30-Day Visitation"
llabels &lt;- c("1-5", "6-10", "11-15", "16+")
#values
pdata1b &lt;- ce
px1b &lt;- ce[,ProvenSR]
py1b &lt;- ce[,tb_score]
groupvar1b &lt;- ce[,vis_bin]
nvar1b &lt;- ce[,USER_COUNT]
#plot itself
plot1b &lt;- ggplot(data=pdata1b,aes(y=py1b,x=as.factor(px1b),fill=as.factor(groupvar1b))) + 
  geom_bar(stat="identity", width = .7, position=position_dodge(), colour="black") +
  scale_fill_brewer(palette = 2, name=lname, labels=llabels) + theme_economist() +
  scale_x_discrete(name="",labels=xlabels) +
  xlab("") + ylab(ylabel) + ggtitle(tlabel) + labs(subtitle=sublabel,caption=caption) +
  geom_text(size = 3.5, aes(label=py1b,y=0), stat="identity", vjust = -2, position = position_dodge(0.7)) +
  geom_text(size = 2.5, aes(label=paste0("n=",nvar1b),y=0), stat= "identity", vjust = -1, position = position_dodge(0.7)) 
print(plot1b)

#put together
plot1 &lt;- plot1a + plot1b
print(plot1)

#store experience: all variables
#melt to do side-by-side barcharts
meltbe &lt;- tempbe[, n := NULL]
meltbe &lt;- melt(meltbe,id=c("vis_bin","ProvenSR"))
meltbe[, variable := ordered(variable, levels = c("Q2_1_score", "Q2_2_score", "Q2_3_score",
                                   "Q2_4_score", "Q2_5_score", "Q2_6_score",
                                   "Q2_7_score", "Q2_8_score"))]

#plot 2: ce from brand equity - non-sr
#set labels
xlabel &lt;- "Non-SR Customers"
xlabels &lt;- c("Speed","CC","Above &amp; Beyond","Order Accuracy","Bev Taste","Food Taste","Cleanliness","Worth")
ylabel &lt;- "Top Box Score"
tlabel &lt;- "Brand Equity Study"
sublabel &lt;- "Customer Experience"
#manual legend labels
lname &lt;- "30-Day Visitation"
llabels &lt;- c("1-5", "6-10", "11-15", "16+")
#values
pdata2 &lt;- meltbe[ProvenSR==0]
px2 &lt;- meltbe[ProvenSR==0,variable]
py2 &lt;- meltbe[ProvenSR==0,value]
groupvar2 &lt;- meltbe[ProvenSR==0,vis_bin]
#plot itself
plot2 &lt;- ggplot(data=pdata2,aes(y=py2,x=as.factor(px2),fill=as.factor(groupvar2))) + 
  geom_bar(stat="identity", width = 0.7, position=position_dodge(), colour="black") +
  scale_fill_brewer(palette = 1, name=lname, labels=llabels) + theme_economist() +
  scale_x_discrete(name=xlabel,labels=xlabels) +
  ylab(ylabel) + ggtitle(tlabel) + labs(subtitle=sublabel) +
  geom_text(size = 2.5, aes(label=py2,y=0), angle=90, hjust=-0.25, stat="identity", position = position_dodge(0.7))

#plot 3: ce from brand equity - sr
#set labels
xlabel &lt;- "SR Customers"
caption &lt;- "Brand Equity Study, December FY18"
#values
pdata3 &lt;- meltbe[ProvenSR==1]
px3 &lt;- meltbe[ProvenSR==1,variable]
py3 &lt;- meltbe[ProvenSR==1,value]
groupvar3 &lt;- meltbe[ProvenSR==1,vis_bin]
#plot itself
plot3 &lt;- ggplot(data=pdata3,aes(y=py3,x=as.factor(px3),fill=as.factor(groupvar3))) + 
  geom_bar(stat="identity", width = 0.7, position=position_dodge(), colour="black") +
  scale_fill_brewer(palette = 1, guide=FALSE) + theme_economist() +
  scale_x_discrete(name=xlabel,labels=xlabels) +
  xlab(xlabel) + ylab(ylabel) + labs(caption=caption) +
  geom_text(size = 2.5, aes(label=py3,y=0), angle=90, hjust=-0.25, stat="identity", position = position_dodge(0.7))


# ##UPDATE TO INCLUDE TRENDED CC BY FREQUENCY BINS &amp; ROLLING 2-MONTHS

#load data
be &lt;- read.spss("//starbucks/amer/portal/Departments/WMO/Marketing Research/New Q drive/Foundational/Brand Equity Monitor/$ Brand Equity 2.0/SPSS/DEC FY18 Final.sav", use.value.labels = FALSE, to.data.frame=TRUE)
#convert to data.table
setDT(be)

#keep only variables we need
be &lt;- be[, .(ProvenSR,Month,Q5Starbucks_TotalVisits,QSB3_MadeAnEffortToGetToKnowMe_slice)]

#drop NA's for core variables
be &lt;- na.omit(be, cols=c("ProvenSR","Month","Q5Starbucks_TotalVisits","QSB3_MadeAnEffortToGetToKnowMe_slice"))

#recode ProvenSR to binary
be[ProvenSR==2, ProvenSR := 0]

#rename long variables
setnames(be,c("Q5Starbucks_TotalVisits","QSB3_MadeAnEffortToGetToKnowMe_slice"), c("visits","Q2_2"))

#create TB variables
be[Q2_2&lt;7, Q2_2_score := 0]; be[Q2_2==7, Q2_2_score := 1]
#create fake variable to calculate response count
be[Q2_2&lt;=7, RSPSN_COUNT := 1]

#ensure it's sorted by year and period for lagging
be &lt;- setorder(be,Month)
#calculate rolling two by vis_bin
be[, lag_TB :=lapply(.SD, function(x) c(NA, x[-.N])), by="ProvenSR", .SDcols="Q2_2_score"]
be[, lag_RSPNS :=lapply(.SD, function(x) c(NA, x[-.N])), by="ProvenSR", .SDcols="RSPSN_COUNT"]
#sum together
be[, R2MTB := rowSums(.SD, na.rm = TRUE), .SDcols=c("Q2_2_score","lag_TB")]
be[, R2MRSPNS := rowSums(.SD, na.rm = TRUE), .SDcols=c("RSPSN_COUNT","lag_RSPNS")]

#keep only FY17 (month 4-15)
be &lt;- be[Month&gt;=4&amp;Month&lt;=15]

#mapvalues
monthnames &lt;- c("2017-01","2017-02","2017-03","2017-04","2017-05","2017-06","2017-07","2017-08","2017-09","2017-10","2017-11","2017-12")
be[, fyfp :=  plyr::mapvalues(be[, Month], from = c(4:15), to = monthnames)]

#create frequency bins (1: 1-5, 2: 6-10, 3: 11-15, 4: 16+)
be[visits&lt;=5, vis_bin := 1]
be[visits&gt;=6&amp;visits&lt;=10, vis_bin := 2]
be[visits&gt;=11&amp;visits&lt;=15, vis_bin := 3]
be[visits&gt;=16, vis_bin := 4]

#aggregate by vis_bin, ProvenSR, and month
be &lt;- be[, list(R2MTB = sum(R2MTB,na.rm=T),
                R2MRSPNS = sum(R2MRSPNS,na.rm=T)),
         by=c("vis_bin","fyfp","ProvenSR")]
be &lt;- setorder(be,vis_bin,fyfp,ProvenSR)

#calculate TB score
be[, tb_score := round(R2MTB/R2MRSPNS,3)]


#bring in our data
ce &lt;- fread("O:/CoOp/CoOp194_PROReportng&amp;OM/Julie/ce_by_customer_frequency_v2.csv")

#keep only question 2
# ce &lt;- ce[QSTN_ID=="Q2_2"]

#create frequency bins (1: 1-5, 2: 6-10, 3: 11-15, 4: 16+)
ce[TRANS&lt;=5, vis_bin := 1]
ce[TRANS&gt;=6&amp;TRANS&lt;=10, vis_bin := 2]
ce[TRANS&gt;=11&amp;TRANS&lt;=15, vis_bin := 3]
ce[TRANS&gt;=16, vis_bin := 4]

#aggregate by vis_bin and month
ce &lt;- ce[, list(USER_COUNT = sum(USER_COUNT,na.rm=T),
                TB_COUNT = sum(TB_COUNT,na.rm=T),
                RSPSN_COUNT = sum(RSPSN_COUNT,na.rm=T)),
         by=c("vis_bin","FSCL_YR_NUM","FSCL_PER_IN_YR_NUM")]

#ensure it's sorted by year and period for lagging
ce &lt;- setorder(ce,FSCL_YR_NUM,FSCL_PER_IN_YR_NUM)
#calculate rolling two by vis_bin
ce[, lag_TB :=lapply(.SD, function(x) c(NA, x[-.N])), by="vis_bin", .SDcols="TB_COUNT"]
ce[, lag_RSPNS :=lapply(.SD, function(x) c(NA, x[-.N])), by="vis_bin", .SDcols="RSPSN_COUNT"]
#sum together
ce[, R2MTB := rowSums(.SD, na.rm = TRUE), .SDcols=c("TB_COUNT","lag_TB")]
ce[, R2MRSPNS := rowSums(.SD, na.rm = TRUE), .SDcols=c("RSPSN_COUNT","lag_RSPNS")]
#drop earliest month
ce &lt;- ce[(FSCL_YR_NUM==2017&amp;FSCL_PER_IN_YR_NUM&gt;=4)|(FSCL_YR_NUM==2018&amp;FSCL_PER_IN_YR_NUM&lt;=3)]
ce[, tb_score := round(R2MTB/R2MRSPNS,3)]

#create fyfp var
ce[, tempvar := paste0(FSCL_YR_NUM,FSCL_PER_IN_YR_NUM)]
#mapvalues
monthnames &lt;- c("2017-01","2017-02","2017-03","2017-04","2017-05","2017-06","2017-07","2017-08","2017-09","2017-10","2017-11","2017-12")
ce[, fyfp :=  plyr::mapvalues(ce[, tempvar], from = unique(ce[, tempvar]), to = monthnames)]
ce[, tempvar := NULL]

#calculate TB score
# ce[, tb_score := round((TB_COUNT / RSPSN_COUNT),3)]

#sort
setorder(ce,vis_bin,fyfp)

#make fake SR variable for plotting
ce[, ProvenSR := 2]

#rbindlist the datasets together
be &lt;- be[,.(vis_bin,fyfp,ProvenSR,tb_score)]
ce &lt;- ce[,.(vis_bin,fyfp,ProvenSR,tb_score)]

#attach columns from brand equity
cebe &lt;- rbind(ce,be)
setDT(cebe)

#set labels
xlabel &lt;- "Time"
ylabel &lt;- "CC Score"
tlabel &lt;- "Customer Connection Trend"
sublabel &lt;- "January - December 2017 (Rolling 2)"
caption &lt;- "Customer Experience and Brand Equity Surveys"
#manual legend labels
lname1 &lt;- "Survey Group"
llabels1 &lt;- c("BE (Non-SR)","BE (SR)","CE (SR)")
lname2 &lt;- "Monthly Visits"
llabels2 &lt;- c("1-5","6-10","11-15","16+")
#values
pdata &lt;- cebe
px &lt;- cebe[,fyfp]
py &lt;- cebe[,tb_score]
groupvar &lt;- cebe[,vis_bin]
colourvar &lt;- cebe[,ProvenSR]
#plot itself
plot2 &lt;- ggplot(data=pdata, aes(x=px, y=py, colour=factor(colourvar), shape=factor(groupvar), group=interaction(groupvar, colourvar))) + 
  geom_point(size=2.5) + geom_line(size=1) +
  xlab("") + ylab(ylabel) + 
  scale_colour_discrete(name=lname1, labels=llabels1, guide=guide_legend(order=1)) +
  guides(colour = guide_legend(override.aes = list(size = 7))) + 
  scale_shape_discrete(name=lname2, labels=llabels2, guide=guide_legend(order=1)) +
  guides(shape = guide_legend(override.aes = list(size = 5))) + 
  scale_y_continuous(limits=c(0,.6)) + theme_economist() +
  ggtitle(tlabel) + labs(subtitle=sublabel,caption=caption)
print(plot2)

#do for just low freq
#set labels
xlabel &lt;- "Time"
ylabel &lt;- "CC Score"
sublabel &lt;- "Customer Connection Trend"
tlabel &lt;- "Low Frequency Customers (1-5 visits/month)"
caption &lt;- "Customer Experience Survey and Brand Equity Surveys, Jan-Dec 2017 (Rolling 2)"
#manual legend labels
lname &lt;- "Survey Group"
llabels &lt;- c("Brand Equity: Non-SR","Brand Equity: SR","Customer Experience Survey")
#values
pdata &lt;- cebe[vis_bin==1]
px &lt;- cebe[vis_bin==1,fyfp]
py &lt;- cebe[vis_bin==1,tb_score]
groupvar &lt;- cebe[vis_bin==1,ProvenSR]
#plot itself
plot2 &lt;- ggplot() +
  geom_line(data=pdata, aes(x=px, y=py, group=factor(groupvar), colour=factor(groupvar))) + 
  xlab("") + ylab(ylabel) + 
  scale_colour_discrete(name=lname, labels=llabels, guide=guide_legend(order=1)) +
  guides(colour = guide_legend(override.aes = list(size = 7))) + 
  scale_y_continuous(limits=c(0,.6)) + theme_economist() +
  ggtitle(tlabel) + labs(subtitle=sublabel,caption=caption)
print(plot2)

#do for just low/mid freq
#set labels
xlabel &lt;- "Time"
ylabel &lt;- "CC Score"
sublabel &lt;- "Customer Connection Trend"
tlabel &lt;- "Low-Mid Frequency Customers (6-10 visits/month)"
caption &lt;- "Customer Experience Survey and Brand Equity Surveys, Jan-Dec 2017 (Rolling 2)"
#manual legend labels
lname &lt;- "Survey Group"
llabels &lt;- c("Brand Equity: Non-SR","Brand Equity: SR","Customer Experience Survey")
#values
pdata &lt;- cebe[vis_bin==2]
px &lt;- cebe[vis_bin==2,fyfp]
py &lt;- cebe[vis_bin==2,tb_score]
groupvar &lt;- cebe[vis_bin==2,ProvenSR]
#plot itself
plot2 &lt;- ggplot() +
  geom_line(data=pdata, aes(x=px, y=py, group=factor(groupvar), colour=factor(groupvar))) + 
  xlab("") + ylab(ylabel) + 
  scale_colour_discrete(name=lname, labels=llabels, guide=guide_legend(order=1)) +
  guides(colour = guide_legend(override.aes = list(size = 7))) + 
  scale_y_continuous(limits=c(0,.6)) + theme_economist() +
  ggtitle(tlabel) + labs(subtitle=sublabel,caption=caption)
print(plot2)

#do for just mid/high freq
#set labels
xlabel &lt;- "Time"
ylabel &lt;- "CC Score"
sublabel &lt;- "Customer Connection Trend"
tlabel &lt;- "Mid-High Frequency Customers (11-15 visits/month)"
caption &lt;- "Customer Experience Survey and Brand Equity Surveys, Jan-Dec 2017 (Rolling 2)"
#manual legend labels
lname &lt;- "Survey Group"
llabels &lt;- c("Brand Equity: Non-SR","Brand Equity: SR","Customer Experience Survey")
#values
pdata &lt;- cebe[vis_bin==3]
px &lt;- cebe[vis_bin==3,fyfp]
py &lt;- cebe[vis_bin==3,tb_score]
groupvar &lt;- cebe[vis_bin==3,ProvenSR]
#plot itself
plot2 &lt;- ggplot() +
  geom_line(data=pdata, aes(x=px, y=py, group=factor(groupvar), colour=factor(groupvar))) + 
  xlab("") + ylab(ylabel) + 
  scale_colour_discrete(name=lname, labels=llabels, guide=guide_legend(order=1)) +
  guides(colour = guide_legend(override.aes = list(size = 7))) + 
  scale_y_continuous(limits=c(0,.6)) + theme_economist() +
  ggtitle(tlabel) + labs(subtitle=sublabel,caption=caption)
print(plot2)

#do for just high freq
#set labels
xlabel &lt;- "Time"
ylabel &lt;- "CC Score"
sublabel &lt;- "Customer Connection Trend"
tlabel &lt;- "High Frequency Customers (16+ visits/month)"
caption &lt;- "Customer Experience Survey and Brand Equity Surveys, Jan-Dec 2017 (Rolling 2)"
#manual legend labels
lname &lt;- "Survey Group"
llabels &lt;- c("Brand Equity: Non-SR","Brand Equity: SR","Customer Experience Survey")
#values
pdata &lt;- cebe[vis_bin==4]
px &lt;- cebe[vis_bin==4,fyfp]
py &lt;- cebe[vis_bin==4,tb_score]
groupvar &lt;- cebe[vis_bin==4,ProvenSR]
#plot itself
plot2 &lt;- ggplot() +
  geom_line(data=pdata, aes(x=px, y=py, group=factor(groupvar), colour=factor(groupvar))) + 
  xlab("") + ylab(ylabel) + 
  scale_colour_discrete(name=lname, labels=llabels, guide=guide_legend(order=1)) +
  guides(colour = guide_legend(override.aes = list(size = 7))) + 
  scale_y_continuous(limits=c(0,.6)) + theme_economist() +
  ggtitle(tlabel) + labs(subtitle=sublabel,caption=caption)
print(plot2)

#do separately for each survey
#set labels
ylabel &lt;- "CC Score"
tlabel &lt;- "Customer Experience Survey"
sublabel &lt;- "January - December 2017 (Rolling 2)"
#manual legend labels
lname2 &lt;- "Monthly Visits"
llabels2 &lt;- c("1-5","6-10","11-15","16+")
#values
pdata &lt;- cebe[ProvenSR==2]
px &lt;- cebe[ProvenSR==2,fyfp]
py &lt;- cebe[ProvenSR==2,tb_score]
groupvar &lt;- cebe[ProvenSR==2,vis_bin]
#plot itself
plot3 &lt;- ggplot(data=pdata, aes(x=px, y=py, group=factor(groupvar), colour=factor(groupvar))) + 
  geom_line() +
  xlab("") + ylab(ylabel) + 
  scale_colour_discrete(name=lname2, labels=llabels2, guide=guide_legend(order=1)) +
  guides(colour = guide_legend(override.aes = list(size = 5))) + 
  scale_y_continuous(limits=c(0,0.6)) + theme_economist() +
  ggtitle(tlabel) + labs(subtitle=sublabel)
print(plot3)</RScript>
          <UseFullUpdate value="False" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
      <EngineSettings EngineDll="AlteryxRPluginEngine.dll" EngineDllEntryPoint="AlteryxR" />
    </Node>
    <Node ToolID="8">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="282" y="54" width="100" height="72" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text>Plots of CC by Cust Freq, Comparison to BE</Text>
          <Font name="Segoe UI" size="8.25" style="1" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="2" />
          <Justification Justification="1" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="9">
      <GuiSettings Plugin="AlteryxBasePluginsGui.DbFileInput.DbFileInput">
        <Position x="678" y="162" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Passwords>49DAF891AB1B58B7702EF676B9DCAA37A04C46A4D</Passwords>
          <File RecordLimit="" FileFormat="17"><![CDATA[oci:JUMORRIS/__EncPwd1__@SBP416.world|||SELECT t.GUID_USER_ID
,t.GENDER
,t.COMBINED_AGE
,t.EDUCATION_MODEL
,t.MARITAL_STATUS
,t.OCCUPATION_GROUP_V2
,t.EST_HOUSEHOLD_INCOME_V5
,sq.TRANS

FROM DEPT_RET_AN.CUSTOMER_TEST t

INNER JOIN (SELECT
  a.GUID_ID
  ,COUNT(*) AS TRANS
FROM APPCA.F_SVC_FIN_TRANS a

INNER JOIN APPCA.D_CAL b 
  ON a.BUS_DT = b.CAL_DT
  WHERE b.FSCL_YR_NUM = 2018 and b.FSCL_PER_IN_YR_NUM = 3

GROUP BY a.GUID_ID
) sq

ON t.GUID_USER_ID = sq.GUID_ID

WHERE t.SBUX_MATCH_LEVEL IN ('IND')
]]></File>
          <FormatSpecificOptions>
            <ForceSqlWcharSupport>False</ForceSqlWcharSupport>
            <ReadCentroids>False</ReadCentroids>
            <TableStyle>Quoted</TableStyle>
            <NoProgress>False</NoProgress>
            <CacheData>False</CacheData>
            <PostSQL />
            <PreSQL />
          </FormatSpecificOptions>
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText><![CDATA[Database: @SBP416.world
Table=SELECT t.GUID_USER_ID
,t.GENDER
,t.COMBINED_AGE
,t.EDUCATION_MODEL
,t.MARITAL_STATUS
,t.OCCUPATION_GROUP_V2
,t.EST_HOUSEHOLD_INCOME_V5
,sq.TRANS

FROM DEPT_RET_AN.CUSTOMER_TEST t

INNER JOIN (SELECT
  a.GUID_ID
  ,COUNT(*) AS TRANS
FROM APPCA.F_SVC_FIN_TRANS a

INNER JOIN APPCA.D_CAL b 
  ON a.BUS_DT = b.CAL_DT
  WHERE b.FSCL_YR_NUM = 2018 and b.FSCL_PER_IN_YR_NUM = 3

GROUP BY a.GUID_ID
) sq

ON t.GUID_USER_ID = sq.GUID_ID

WHERE t.SBUX_MATCH_LEVEL IN ('IND')
]]></DefaultAnnotationText>
          <Left value="False" />
        </Annotation>
      </Properties>
      <EngineSettings EngineDll="AlteryxBasePluginsEngine.dll" EngineDllEntryPoint="AlteryxDbFileInput" />
    </Node>
    <Node ToolID="10">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="654" y="66" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text>Experian demos for SR GUIDs</Text>
          <Font name="Segoe UI" size="8.25" style="1" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="2" />
          <Justification Justification="1" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="11">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="654" y="114" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text>Pulls Experian demographic information for GUIDs who made transactions within FY18 P3. Use this to link to SR CE and non-CE GUIDs. By customer frequency.</Text>
          <Font name="Segoe UI" size="8.25" style="0" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="0" />
          <Justification Justification="4" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="12">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="834" y="54" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text><![CDATA[CE SR GUIDs by Customer Freq
]]></Text>
          <Font name="Segoe UI" size="8.25" style="1" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="2" />
          <Justification Justification="1" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="13">
      <GuiSettings Plugin="AlteryxBasePluginsGui.DbFileInput.DbFileInput">
        <Position x="846" y="162" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Passwords>498212DC0C96BB024DC50B75B7220C9B5ED03B6C6DE73</Passwords>
          <File RecordLimit="" FileFormat="17"><![CDATA[oci:JUMORRIS/__EncPwd1__@SBP416.world|||select b.FSCL_YR_NUM
  ,b.FSCL_PER_IN_YR_NUM
  ,a.GUID_ID
  ,count(*) AS TRANS

from APPCA.F_SVC_FIN_TRANS a

inner join APPCA.D_CAL b 
  on a.BUS_DT = b.CAL_DT

inner join APPCA.D_SVC_TRANS_TYPE c 
  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY
  
JOIN APPCA.D_STORE_VERS st
  ON a.STORE_NUM = st.STORE_NUM
    AND st.CURRENT_FLG = 'Y'
    AND st.OWNR_TYPE_CD = 'CO'
    AND st.CNTRY_CD_2_DGT_ISO = 'US'

inner join (SELECT
  sr.GUID_USER_ID
  ,ca.FSCL_YR_NUM
  ,ca.FSCL_PER_IN_YR_NUM
  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE

FROM APPOTHER.AFT_CV_SRVY_RSPNS sr

JOIN APPCA.D_CAL ca
  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)

WHERE ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM = 3
  AND sr.QSTN_ID IN ('Q2_2')

  AND sr.RSPNS_ID <> '9'

GROUP BY 
  sr.GUID_USER_ID
  ,ca.FSCL_YR_NUM
  ,ca.FSCL_PER_IN_YR_NUM
  ,TRUNC(sr.TRANS_DTM)
  ) sq
  
ON a.GUID_ID = sq.GUID_USER_ID
  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM
  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM

where c.SVC_INTRNL_RQST_NM = 'Redemption' 
  AND b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM = 3

group by b.FSCL_YR_NUM
  ,b.FSCL_PER_IN_YR_NUM
  ,a.GUID_ID

  

]]></File>
          <FormatSpecificOptions>
            <ForceSqlWcharSupport>False</ForceSqlWcharSupport>
            <ReadCentroids>False</ReadCentroids>
            <TableStyle>Quoted</TableStyle>
            <NoProgress>False</NoProgress>
            <CacheData>False</CacheData>
            <PostSQL />
            <PreSQL />
          </FormatSpecificOptions>
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText><![CDATA[Database: @SBP416.world
Table=select b.FSCL_YR_NUM
  ,b.FSCL_PER_IN_YR_NUM
  ,a.GUID_ID
  ,count(*) AS TRANS

from APPCA.F_SVC_FIN_TRANS a

inner join APPCA.D_CAL b 
  on a.BUS_DT = b.CAL_DT

inner join APPCA.D_SVC_TRANS_TYPE c 
  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY
  
JOIN APPCA.D_STORE_VERS st
  ON a.STORE_NUM = st.STORE_NUM
    AND st.CURRENT_FLG = 'Y'
    AND st.OWNR_TYPE_CD = 'CO'
    AND st.CNTRY_CD_2_DGT_ISO = 'US'

inner join (SELECT
  sr.GUID_USER_ID
  ,ca.FSCL_YR_NUM
  ,ca.FSCL_PER_IN_YR_NUM
  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE

FROM APPOTHER.AFT_CV_SRVY_RSPNS sr

JOIN APPCA.D_CAL ca
  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)

WHERE ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM = 3
  AND sr.QSTN_ID IN ('Q2_2')

  AND sr.RSPNS_ID <> '9'

GROUP BY 
  sr.GUID_USER_ID
  ,ca.FSCL_YR_NUM
  ,ca.FSCL_PER_IN_YR_NUM
  ,TRUNC(sr.TRANS_DTM)
  ) sq
  
ON a.GUID_ID = sq.GUID_USER_ID
  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM
  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM

where c.SVC_INTRNL_RQST_NM = 'Redemption' 
  AND b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM = 3

group by b.FSCL_YR_NUM
  ,b.FSCL_PER_IN_YR_NUM
  ,a.GUID_ID

  

]]></DefaultAnnotationText>
          <Left value="False" />
        </Annotation>
        <MetaInfo connection="Output">
          <RecordInfo>
            <Field name="FSCL_YR_NUM" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM = 3&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM = 3&#xA;&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;&#xA;  &#xA;&#xA;" type="Double" />
            <Field name="FSCL_PER_IN_YR_NUM" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM = 3&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM = 3&#xA;&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;&#xA;  &#xA;&#xA;" type="Double" />
            <Field name="GUID_ID" size="41" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM = 3&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM = 3&#xA;&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;&#xA;  &#xA;&#xA;" type="V_WString" />
            <Field name="TRANS" source="File: oci:JUMORRIS/__EncPwd1__@SBP416.world|||select b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;  ,count(*) AS TRANS&#xA;&#xA;from APPCA.F_SVC_FIN_TRANS a&#xA;&#xA;inner join APPCA.D_CAL b &#xA;  on a.BUS_DT = b.CAL_DT&#xA;&#xA;inner join APPCA.D_SVC_TRANS_TYPE c &#xA;  on a.SVC_TRANS_TYPE_KEY = c.SVC_TRANS_TYPE_KEY&#xA;  &#xA;JOIN APPCA.D_STORE_VERS st&#xA;  ON a.STORE_NUM = st.STORE_NUM&#xA;    AND st.CURRENT_FLG = 'Y'&#xA;    AND st.OWNR_TYPE_CD = 'CO'&#xA;    AND st.CNTRY_CD_2_DGT_ISO = 'US'&#xA;&#xA;inner join (SELECT&#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM) AS SVY_RSPN_DATE&#xA;&#xA;FROM APPOTHER.AFT_CV_SRVY_RSPNS sr&#xA;&#xA;JOIN APPCA.D_CAL ca&#xA;  ON ca.CAL_DT = TRUNC(sr.TRANS_DTM)&#xA;&#xA;WHERE ca.FSCL_YR_NUM = 2018 and ca.FSCL_PER_IN_YR_NUM = 3&#xA;  AND sr.QSTN_ID IN ('Q2_2')&#xA;&#xA;  AND sr.RSPNS_ID &lt;&gt; '9'&#xA;&#xA;GROUP BY &#xA;  sr.GUID_USER_ID&#xA;  ,ca.FSCL_YR_NUM&#xA;  ,ca.FSCL_PER_IN_YR_NUM&#xA;  ,TRUNC(sr.TRANS_DTM)&#xA;  ) sq&#xA;  &#xA;ON a.GUID_ID = sq.GUID_USER_ID&#xA;  AND b.FSCL_YR_NUM = sq.FSCL_YR_NUM&#xA;  AND b.FSCL_PER_IN_YR_NUM = sq.FSCL_PER_IN_YR_NUM&#xA;&#xA;where c.SVC_INTRNL_RQST_NM = 'Redemption' &#xA;  AND b.FSCL_YR_NUM = 2018  and b.FSCL_PER_IN_YR_NUM = 3&#xA;&#xA;group by b.FSCL_YR_NUM&#xA;  ,b.FSCL_PER_IN_YR_NUM&#xA;  ,a.GUID_ID&#xA;&#xA;  &#xA;&#xA;" type="Double" />
          </RecordInfo>
        </MetaInfo>
      </Properties>
      <EngineSettings EngineDll="AlteryxBasePluginsEngine.dll" EngineDllEntryPoint="AlteryxDbFileInput" />
    </Node>
    <Node ToolID="14">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="282" y="270" width="100" height="72" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text>Experian Demographic Profiles</Text>
          <Font name="Segoe UI" size="8.25" style="1" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="2" />
          <Justification Justification="1" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="15">
      <GuiSettings Plugin="AlteryxRPluginGui.R">
        <Position x="306" y="366" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <RScript>##EXPERIAN DEMOS
#load data
experian &lt;- fread("O:/CoOp/CoOp194_PROReportng&amp;OM/Julie/GUIDs_from_experian.csv")
setnames(experian,"GUID_USER_ID","GUID_ID")
guids_cesr &lt;- fread("O:/CoOp/CoOp194_PROReportng&amp;OM/Julie/GUIDs_for_experian_ceSR.csv")
#remove duplicates
guids_cesr &lt;- subset(guids_cesr, !duplicated(guids_cesr$GUID_ID))
#drop transaction indicator (redundant variable with experian data)
guids_cesr[, TRANS := NULL]
#add CE flag
guids_cesr[, CEtaker := 1]
#merge into experian data
experian &lt;- merge(experian,guids_cesr,all.x=T,by="GUID_ID")
#if CE taker is null, make it 0
experian[is.na(CEtaker), CEtaker := 0]

#recode the demographic variables
#sex
experian[GENDER=="M", female := 0]; experian[GENDER=="F", female := 1]
#income
experian[EST_HOUSEHOLD_INCOME_V5=="A", inc_midpt := 6999.5]
experian[EST_HOUSEHOLD_INCOME_V5=="B", inc_midpt := 19999]
experian[EST_HOUSEHOLD_INCOME_V5=="C", inc_midpt := 29999]
experian[EST_HOUSEHOLD_INCOME_V5=="D", inc_midpt := 42499.5]
experian[EST_HOUSEHOLD_INCOME_V5=="E", inc_midpt := 62499.5]
experian[EST_HOUSEHOLD_INCOME_V5=="F", inc_midpt := 87499.5]
experian[EST_HOUSEHOLD_INCOME_V5=="G", inc_midpt := 112499.5]
experian[EST_HOUSEHOLD_INCOME_V5=="H", inc_midpt := 137499.5]
experian[EST_HOUSEHOLD_INCOME_V5=="I", inc_midpt := 162499.5]
experian[EST_HOUSEHOLD_INCOME_V5=="J", inc_midpt := 162499.5]
experian[EST_HOUSEHOLD_INCOME_V5=="K", inc_midpt := 187499.5]
experian[EST_HOUSEHOLD_INCOME_V5=="L", inc_midpt := 250000]
#education - make binary college grad
experian[EDUCATION_MODEL==11|EDUCATION_MODEL==15|EDUCATION_MODEL==51|EDUCATION_MODEL==55, collegegrad := 0]
experian[(EDUCATION_MODEL&gt;=12&amp;EDUCATION_MODEL&lt;=14)|(EDUCATION_MODEL&gt;=52&amp;EDUCATION_MODEL&lt;=54), collegegrad := 1]
#remove letters from age variable
experian[, age := as.numeric(gsub("[^0-9.]", "", COMBINED_AGE))]
#marital status
experian[MARITAL_STATUS=="5S", married := 0]
experian[MARITAL_STATUS=="1M"|MARITAL_STATUS=="5M", married := 1]

#create frequency bins (1: 1-5, 2: 6-10, 3: 11-15, 4: 16+)
experian[TRANS&lt;=5, vis_bin := 1]
experian[TRANS&gt;=6&amp;TRANS&lt;=10, vis_bin := 2]
experian[TRANS&gt;=11&amp;TRANS&lt;=15, vis_bin := 3]
experian[TRANS&gt;=16, vis_bin := 4]

#get percentages
temp &lt;- experian %&gt;% group_by(CEtaker,vis_bin) %&gt;%
  summarise(collegegrad = round(mean(collegegrad,na.rm=T),3)*100,
            age = round(mean(age,na.rm=T),1),
            married = round(mean(married,na.rm=T),3)*100,
            female = round(mean(female,na.rm=T),3)*100,
            inc_med = median(inc_midpt,na.rm=T))
setDT(temp)

temp2 &lt;- experian %&gt;% group_by(CEtaker) %&gt;%
  summarise(collegegrad = round(mean(collegegrad,na.rm=T),3)*100,
            age = round(mean(age,na.rm=T),1),
            married = round(mean(married,na.rm=T),3)*100,
            female = round(mean(female,na.rm=T),3)*100,
            inc_med = median(inc_midpt,na.rm=T))
setDT(temp2)

temp3 &lt;- experian %&gt;% group_by(vis_bin) %&gt;%
  summarise(collegegrad = round(mean(collegegrad,na.rm=T),3)*100,
            age = round(mean(age,na.rm=T),1),
            married = round(mean(married,na.rm=T),3)*100,
            female = round(mean(female,na.rm=T),3)*100,
            inc_med = median(inc_midpt,na.rm=T))
setDT(temp3)

temp4 &lt;- experian %&gt;% 
  summarise(collegegrad = round(mean(collegegrad,na.rm=T),3)*100,
            age = round(mean(age,na.rm=T),1),
            married = round(mean(married,na.rm=T),3)*100,
            female = round(mean(female,na.rm=T),3)*100,
            inc_med = median(inc_midpt,na.rm=T))
setDT(temp4)

#t tests
t.test(experian[CEtaker==0,collegegrad],experian[CEtaker==1,collegegrad])
t.test(experian[CEtaker==0,age],experian[CEtaker==1,age])
t.test(experian[CEtaker==0,married],experian[CEtaker==1,married])
t.test(experian[CEtaker==0,female],experian[CEtaker==1,female])</RScript>
          <UseFullUpdate value="False" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
      <EngineSettings EngineDll="AlteryxRPluginEngine.dll" EngineDllEntryPoint="AlteryxR" />
    </Node>
    <Node ToolID="16">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="834" y="114" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text>GUIDs for users who took the CE survey in FY18 P3. By customer frequency.</Text>
          <Font name="Segoe UI" size="8.25" style="0" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="0" />
          <Justification Justification="4" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="17">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="966" y="54" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text><![CDATA[SO Scores by GUID
]]></Text>
          <Font name="Segoe UI" size="8.25" style="1" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="2" />
          <Justification Justification="1" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
    <Node ToolID="18">
      <GuiSettings Plugin="AlteryxGuiToolkit.TextBox.TextBox">
        <Position x="966" y="114" width="100" height="40" />
      </GuiSettings>
      <Properties>
        <Configuration>
          <Text>SO Scores by GUID. To be pulled into existing groupings / CC scores from earlier pulls, by GUID.</Text>
          <Font name="Segoe UI" size="8.25" style="0" />
          <TextColor name="Black" />
          <FillColor name="White" />
          <Shape shape="0" />
          <Justification Justification="4" />
        </Configuration>
        <Annotation DisplayMode="0">
          <Name />
          <DefaultAnnotationText />
          <Left value="False" />
        </Annotation>
      </Properties>
    </Node>
  </Nodes>
  <Connections>
    <Connection>
      <Origin ToolID="1" Connection="Output" />
      <Destination ToolID="2" Connection="Input" />
    </Connection>
  </Connections>
  <Properties>
    <Memory default="True" />
    <GlobalRecordLimit value="0" />
    <TempFiles default="True" />
    <Annotation on="True" includeToolName="False" />
    <ConvErrorLimit value="10" />
    <ConvErrorLimit_Stop value="False" />
    <CancelOnError value="False" />
    <DisableBrowse value="False" />
    <EnablePerformanceProfiling value="False" />
    <DisableAllOutput value="False" />
    <ShowAllMacroMessages value="False" />
    <ShowConnectionStatusIsOn value="True" />
    <ShowConnectionStatusOnlyWhenRunning value="True" />
    <ZoomLevel value="0" />
    <LayoutType>Horizontal</LayoutType>
    <MetaInfo>
      <NameIsFileName value="True" />
      <Name>CE_adhocs_SirenWorks__SBP416</Name>
      <Description />
      <RootToolName />
      <ToolVersion />
      <ToolInDb value="False" />
      <CategoryName />
      <SearchTags />
      <Author />
      <Company />
      <Copyright />
      <DescriptionLink actual="" displayed="" />
      <Example>
        <Description />
        <File />
      </Example>
    </MetaInfo>
    <Events>
      <Enabled value="True" />
    </Events>
  </Properties>
</AlteryxDocument>